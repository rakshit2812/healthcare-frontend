<app-navbar></app-navbar>

<div class="dashboard-container">
  <h2>Doctor Dashboard</h2>
  
  <div *ngIf="message" [class]="'message message-' + messageType">
    {{ message }}
  </div>
  
  <div class="tabs">
    <button 
      [class.active]="activeTab === 'appointments'"
      (click)="setTab('appointments')">
      Today's Appointments
    </button>
    <button 
      [class.active]="activeTab === 'availability'"
      (click)="setTab('availability')">
      Set Availability
    </button>
  </div>
  
  <!-- Appointments Tab -->
  <div *ngIf="activeTab === 'appointments'" class="tab-content">
    <!-- Subtabs for filtering appointments -->
    <div class="subtabs">
      <button 
        [class.active]="appointmentSubTab === 'booked'"
        (click)="setAppointmentSubTab('booked')"
        class="subtab-btn">
        📋 Booked <span class="badge">{{ getAppointmentCount('booked') }}</span>
      </button>
      <button 
        [class.active]="appointmentSubTab === 'completed'"
        (click)="setAppointmentSubTab('completed')"
        class="subtab-btn">
        ✅ Completed <span class="badge">{{ getAppointmentCount('completed') }}</span>
      </button>
      <button 
        [class.active]="appointmentSubTab === 'cancelled'"
        (click)="setAppointmentSubTab('cancelled')"
        class="subtab-btn">
        ❌ Cancelled <span class="badge">{{ getAppointmentCount('cancelled') }}</span>
      </button>
    </div>

    <div *ngIf="appointments.length === 0" class="card">
      <div class="empty-state">
        📅 No appointments found. Enjoy your day!
      </div>
    </div>
    
    <div *ngIf="getFilteredAppointments().length === 0 && appointments.length > 0" class="card">
      <div class="empty-state">
        No {{ appointmentSubTab }} appointments found.
      </div>
    </div>
    
    <div *ngIf="getFilteredAppointments().length > 0" class="appointments-grid">
      <div *ngFor="let apt of getFilteredAppointments()" class="appointment-card">
        <!-- Header with Patient Info -->
        <div class="appointment-header">
          <div class="appointment-avatar">
            {{ getPatientInitials(apt.patient.name) }}
          </div>
          <div class="appointment-patient-info">
            <h4 class="appointment-patient-name">{{ apt.patient.name }}</h4>
            <p class="appointment-patient-email">{{ apt.patient.email }}</p>
          </div>
          <span [class]="'appointment-status ' + apt.status.toLowerCase()">
            {{ apt.status }}
          </span>
        </div>
        
        <!-- Appointment Details -->
        <div class="appointment-details">
          <div class="appointment-detail-item">
            <div class="appointment-detail-icon">📅</div>
            <div class="appointment-detail-content">
              <div class="appointment-detail-label">Date</div>
              <div class="appointment-detail-value">{{ formatDate(apt.datetime) }}</div>
            </div>
          </div>
          
          <div class="appointment-detail-item">
            <div class="appointment-detail-icon">🕐</div>
            <div class="appointment-detail-content">
              <div class="appointment-detail-label">Time</div>
              <div class="appointment-detail-value">{{ formatTime(apt.datetime) }}</div>
            </div>
          </div>
          
          <div class="appointment-detail-item">
            <div class="appointment-detail-icon">🆔</div>
            <div class="appointment-detail-content">
              <div class="appointment-detail-label">Appointment ID</div>
              <div class="appointment-detail-value">{{ apt._id }}</div>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="appointment-actions" *ngIf="apt.status === 'booked'">
          <button 
            class="btn btn-primary"
            (click)="openPrescriptionModal(apt)">
            💊 Add Prescription
          </button>
        </div>
        <div class="appointment-actions" *ngIf="apt.status === 'completed'">
          <span style="color: #6a1b9a; font-weight: 600;">✓ Consultation Completed</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Availability Tab -->
  <div *ngIf="activeTab === 'availability'" class="tab-content">
    <div class="card">
      <h3>⏰ Set Your Availability</h3>
      
      <form (ngSubmit)="submitAvailability()">
        <div class="form-group">
          <label>📅 Date</label>
          <input 
            type="date" 
            [(ngModel)]="availabilityForm.date" 
            name="date"
            required>
        </div>
        
        <div class="form-group">
          <label>🕐 Time Slots (comma separated)</label>
          <input 
            type="text" 
            [(ngModel)]="availabilityForm.slots" 
            name="slots"
            placeholder="e.g., 09:00, 09:30, 10:00, 10:30, 11:00"
            required>
        </div>
        
        <button type="submit" class="btn btn-primary">✓ Set Availability</button>
      </form>
      
      <div class="availability-preview" *ngIf="availabilityForm.slots">
        <h4>Preview Slots:</h4>
        <div class="slot-preview">
          <span class="slot-tag" *ngFor="let slot of availabilityForm.slots.split(',')">
            {{ slot.trim() }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Prescription Modal -->
  <div *ngIf="showPrescriptionModal" class="modal-overlay" (click)="closePrescriptionModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-wrapper">
          <div class="modal-icon">💊</div>
          <h3 class="modal-title">Add Prescription</h3>
        </div>
        <button class="modal-close" (click)="closePrescriptionModal()">×</button>
      </div>

      <div class="modal-body">
        <div class="modal-patient-info">
          <h4>Patient: {{ selectedAppointment?.patient?.name }}</h4>
          <p>Email: {{ selectedAppointment?.patient?.email }}</p>
          <p>Appointment Time: {{ formatTime(selectedAppointment?.datetime) }}</p>
        </div>

        <form (ngSubmit)="submitPrescription()">
          <div class="form-group">
            <label>📋 Diagnosis Notes</label>
            <textarea 
              [(ngModel)]="prescriptionForm.notes" 
              name="notes"
              rows="4"
              placeholder="Enter diagnosis notes, symptoms, and treatment plan..."
              required></textarea>
          </div>
          
          <div class="form-group">
            <label>💊 Medicines (comma separated)</label>
            <input 
              type="text" 
              [(ngModel)]="prescriptionForm.medicines" 
              name="medicines"
              placeholder="e.g., Paracetamol 500mg, Ibuprofen 400mg, Amoxicillin 250mg"
              required>
          </div>
          
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">
              ✓ Submit & Complete Appointment
            </button>
            <button 
              type="button" 
              class="btn btn-secondary"
              (click)="closePrescriptionModal()">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>